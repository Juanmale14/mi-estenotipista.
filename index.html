<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi estenotipista - Transcripción Pro</title>
    <!-- Librería para mp3 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lamejs/1.2.1/lame.all.min.js"></script>
    <style>
        :root {
            --bg-color: #f8fafc;
            --glass-bg: rgba(255, 255, 255, 0.8);
            --glass-border: rgba(255, 255, 255, 0.4);
            --text-color: #1e293b;
            --primary: #6366f1;
            --secondary: #ec4899;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --neutral: #64748b;
            --shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.1);
            --speaker-bg: rgba(99, 102, 241, 0.05);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem;
            background-image: 
                radial-gradient(circle at 0% 0%, rgba(99, 102, 241, 0.08) 0%, transparent 40%),
                radial-gradient(circle at 100% 100%, rgba(236, 72, 153, 0.08) 0%, transparent 40%);
        }

        .container {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            border-radius: 32px;
            padding: 2.5rem;
            width: 100%;
            max-width: 900px;
            box-shadow: var(--shadow);
            position: relative;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .timer {
            font-family: 'Courier New', monospace;
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-color);
            background: rgba(0,0,0,0.04);
            padding: 8px 20px;
            border-radius: 14px;
            border: 1px solid rgba(0,0,0,0.05);
        }

        .visualizer-container {
            width: 100%;
            height: 80px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 16px;
            margin-bottom: 25px;
            overflow: hidden;
            border: 1px solid var(--glass-border);
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.02);
        }

        #audioVisualizer {
            width: 100%;
            height: 100%;
            display: block;
        }

        .controls {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        button {
            padding: 0.8rem 1.4rem;
            border-radius: 14px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }

        button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        button:active { transform: scale(0.96); }
        button:disabled { opacity: 0.4; cursor: not-allowed; box-shadow: none; }

        .btn-start { background: var(--primary); color: white; }
        .btn-pause { background: var(--warning); color: white; }
        .btn-stop { background: var(--danger); color: white; }
        .btn-clear { background: var(--neutral); color: white; }
        .btn-export { background: var(--success); color: white; }
        .btn-audio { background: var(--secondary); color: white; }

        .transcription-box {
            background: rgba(255, 255, 255, 0.4);
            border-radius: 20px;
            padding: 1.8rem;
            min-height: 300px;
            max-height: 450px;
            overflow-y: auto;
            margin-bottom: 25px;
            border: 1px solid var(--glass-border);
            box-shadow: inset 0 4px 12px rgba(0,0,0,0.03);
            scrollbar-width: thin;
        }

        .speaker-block {
            margin-bottom: 1.2rem;
            padding: 1rem;
            border-left: 4px solid var(--primary);
            background: var(--speaker-bg);
            border-radius: 4px 12px 12px 4px;
            line-height: 1.7;
            animation: fadeIn 0.4s ease-out;
            color: #334155;
        }

        .interim-text {
            color: #94a3b8;
            font-style: italic;
            padding-left: 1rem;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        footer {
            margin-top: 2rem;
            text-align: center;
            font-size: 0.9rem;
            color: #64748b;
        }

        footer a { color: var(--primary); text-decoration: none; font-weight: 600; }

        #processingOverlay {
            display: none;
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95);
            z-index: 100;
            border-radius: 32px;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            text-align: center;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="container">
        <div id="processingOverlay">
            <div class="loader"></div>
            <p style="font-size: 1.2rem; font-weight: bold;">Generando archivo MP3...</p>
            <p style="font-size: 0.9rem; margin-top: 8px; font-weight: normal; color: #64748b;">Estamos procesando el audio, un momento por favor.</p>
        </div>

        <header>
            <div style="font-size: 1.6rem; font-weight: 800; letter-spacing: -0.5px; background: linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Mi estenotipista</div>
            <div class="timer" id="timerDisplay">00:00:00</div>
        </header>

        <div class="visualizer-container">
            <canvas id="audioVisualizer"></canvas>
        </div>

        <div class="controls">
            <button id="btnStart" class="btn-start">
                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M5 3l14 9-14 9V3z"/></svg>
                GRABAR
            </button>
            <button id="btnPause" class="btn-pause" disabled>
                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/></svg>
                PAUSAR
            </button>
            <button id="btnStop" class="btn-stop" disabled>
                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" rx="2"/></svg>
                DETENER
            </button>
            <button id="btnClear" class="btn-clear">
                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M19 6L5 20M5 6l14 14"/></svg>
                LIMPIAR
            </button>
        </div>

        <div class="transcription-box" id="transcriptionDisplay">
            <div id="textHistory"></div>
            <div id="interimArea" class="interim-text"></div>
            <p id="emptyMsg" style="color: #94a3b8; text-align: center; margin-top: 40px;">Pulsa "Grabar" para capturar audio y texto en tiempo real...</p>
        </div>

        <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
            <button id="btnExportTxt" class="btn-export" disabled>EXPORTAR TEXTO (.txt)</button>
            <button id="btnExportAudio" class="btn-audio" disabled>EXPORTAR AUDIO (.mp3)</button>
        </div>
    </div>

    <footer>
        Creado en 2026 por <a href="https://blogsaverroes.juntadeandalucia.es/ellocodelamochila/" target="_blank">El loco de la mochila</a>
    </footer>

    <script>
        let recognition;
        let mediaRecorder;
        let audioChunks = [];
        let combinedStream;
        let isRecording = false;
        let isPaused = false;
        let startTime, timerInterval;
        let totalElapsed = 0;
        let audioContext;
        let analyser;
        let dataArray;
        let animationId;

        // Paleta de colores pasteles para las ondas
        const pastelColors = [
            '#FFB7B2', '#FFDAC1', '#E2F0CB', '#B5EAD7', '#C7CEEA', 
            '#FAD2E1', '#EEE1F3', '#D0E1F9', '#FFF1E6', '#DFE7FD'
        ];

        const display = document.getElementById('transcriptionDisplay');
        const textHistory = document.getElementById('textHistory');
        const interimArea = document.getElementById('interimArea');
        const emptyMsg = document.getElementById('emptyMsg');
        const timerDisplay = document.getElementById('timerDisplay');
        
        const btnStart = document.getElementById('btnStart');
        const btnPause = document.getElementById('btnPause');
        const btnStop = document.getElementById('btnStop');
        const btnClear = document.getElementById('btnClear');
        const canvas = document.getElementById('audioVisualizer');
        const canvasCtx = canvas.getContext('2d');

        function resizeCanvas() {
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
        }
        window.onresize = resizeCanvas;
        resizeCanvas();

        function drawVisualizer() {
            if (!analyser) return;
            animationId = requestAnimationFrame(drawVisualizer);
            analyser.getByteFrequencyData(dataArray);

            canvasCtx.clearRect(0, 0, canvas.width, canvas.height);

            const barWidth = (canvas.width / (dataArray.length / 2));
            let x = 0;

            for(let i = 0; i < dataArray.length / 2; i++) {
                const barHeight = (dataArray[i] / 255) * canvas.height * 0.8;
                
                // Color pastel según la posición
                const colorIndex = Math.floor((i / (dataArray.length / 2)) * pastelColors.length);
                canvasCtx.fillStyle = pastelColors[colorIndex];
                
                // Dibujar barra con bordes redondeados (simulado)
                const yPos = (canvas.height - barHeight) / 2;
                canvasCtx.fillRect(x, yPos, barWidth - 2, barHeight);
                
                x += barWidth;
            }
        }

        function initRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) return null;
            
            const rec = new SpeechRecognition();
            rec.continuous = true;
            rec.interimResults = true;
            rec.lang = 'es-ES';

            rec.onresult = (event) => {
                if (isPaused) return;
                
                let interimTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        const p = document.createElement('p');
                        p.className = 'speaker-block';
                        p.innerText = event.results[i][0].transcript;
                        textHistory.appendChild(p);
                        emptyMsg.style.display = 'none';
                        display.scrollTop = display.scrollHeight;
                        document.getElementById('btnExportTxt').disabled = false;
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }
                interimArea.innerText = interimTranscript;
                if (interimTranscript) {
                    emptyMsg.style.display = 'none';
                    display.scrollTop = display.scrollHeight;
                }
            };
            
            rec.onend = () => { if (isRecording && !isPaused) rec.start(); };
            return rec;
        }

        async function startRecording() {
            try {
                if (isPaused) {
                    resumeRecording();
                    return;
                }

                audioChunks = [];
                let streams = [];

                const micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                streams.push(micStream);

                if (navigator.mediaDevices.getDisplayMedia) {
                    try {
                        const systemStream = await navigator.mediaDevices.getDisplayMedia({ 
                            audio: true, video: { width: 1, height: 1 } 
                        });
                        streams.push(systemStream);
                    } catch (e) { console.log("Audio de sistema omitido."); }
                }

                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                const dest = audioContext.createMediaStreamDestination();
                
                streams.forEach(s => {
                    const source = audioContext.createMediaStreamSource(s);
                    source.connect(analyser);
                    source.connect(dest);
                });
                
                analyser.fftSize = 128;
                dataArray = new Uint8Array(analyser.frequencyBinCount);
                drawVisualizer();

                combinedStream = dest.stream;
                const mimeType = MediaRecorder.isTypeSupported('audio/mp4') ? 'audio/mp4' : 'audio/webm';
                mediaRecorder = new MediaRecorder(combinedStream, { mimeType });
                
                mediaRecorder.ondataavailable = e => { if(e.data.size > 0) audioChunks.push(e.data); };
                mediaRecorder.onstop = () => document.getElementById('btnExportAudio').disabled = false;
                mediaRecorder.start(1000);

                recognition = initRecognition();
                recognition.start();

                isRecording = true;
                isPaused = false;
                startTime = Date.now();
                totalElapsed = 0;
                timerInterval = setInterval(updateTimer, 1000);

                updateUI('recording');
            } catch (err) {
                alert("No se pudo iniciar la grabación. Asegúrate de dar permisos de micrófono.");
            }
        }

        function updateTimer() {
            const currentTotal = Math.floor((Date.now() - startTime + totalElapsed) / 1000);
            const s = currentTotal % 60;
            const m = Math.floor(currentTotal / 60) % 60;
            const h = Math.floor(currentTotal / 3600);
            timerDisplay.innerText = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        function pauseRecording() {
            isPaused = true;
            totalElapsed += Date.now() - startTime;
            clearInterval(timerInterval);
            mediaRecorder.pause();
            recognition.stop();
            cancelAnimationFrame(animationId);
            updateUI('paused');
        }

        function resumeRecording() {
            isPaused = false;
            startTime = Date.now();
            timerInterval = setInterval(updateTimer, 1000);
            mediaRecorder.resume();
            recognition.start();
            drawVisualizer();
            updateUI('recording');
        }

        function stopRecording() {
            isRecording = false;
            isPaused = false;
            clearInterval(timerInterval);
            cancelAnimationFrame(animationId);
            if (mediaRecorder) mediaRecorder.stop();
            if (recognition) recognition.stop();
            if (combinedStream) combinedStream.getTracks().forEach(t => t.stop());
            updateUI('idle');
        }

        function clearData() {
            if (isRecording) {
                if (!confirm("¿Seguro que quieres borrar todo? La grabación actual se detendrá.")) return;
                stopRecording();
            }
            textHistory.innerHTML = "";
            interimArea.innerHTML = "";
            emptyMsg.style.display = 'block';
            audioChunks = [];
            timerDisplay.innerText = "00:00:00";
            totalElapsed = 0;
            document.getElementById('btnExportTxt').disabled = true;
            document.getElementById('btnExportAudio').disabled = true;
            canvasCtx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function updateUI(state) {
            btnStart.disabled = (state === 'recording');
            btnPause.disabled = (state === 'idle');
            btnStop.disabled = (state === 'idle');
            
            if (state === 'paused') {
                btnPause.innerHTML = `<svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M5 3l14 9-14 9V3z"/></svg> REANUDAR`;
                btnPause.style.background = 'var(--primary)';
            } else {
                btnPause.innerHTML = `<svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/></svg> PAUSAR`;
                btnPause.style.background = 'var(--warning)';
            }
        }

        async function exportMp3() {
            if (audioChunks.length === 0) return;
            document.getElementById('processingOverlay').style.display = 'flex';
            try {
                const blob = new Blob(audioChunks);
                const arrayBuffer = await blob.arrayBuffer();
                const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                const samples = audioBuffer.getChannelData(0);
                const mp3encoder = new lamejs.Mp3Encoder(1, audioBuffer.sampleRate, 128);
                const mp3Data = [];
                const int16Samples = new Int16Array(samples.length);
                for (let i = 0; i < samples.length; i++) {
                    let s = Math.max(-1, Math.min(1, samples[i]));
                    int16Samples[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
                }
                const blockSize = 1152;
                for (let i = 0; i < int16Samples.length; i += blockSize) {
                    const chunk = int16Samples.subarray(i, i + blockSize);
                    const mp3buf = mp3encoder.encodeBuffer(chunk);
                    if (mp3buf.length > 0) mp3Data.push(mp3buf);
                }
                const end = mp3encoder.flush();
                if (end.length > 0) mp3Data.push(end);
                const finalBlob = new Blob(mp3Data, { type: 'audio/mp3' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(finalBlob);
                a.download = `STENOTIPISTA_AUDIO_${Date.now()}.mp3`;
                a.click();
            } catch (e) { alert("Error al procesar audio. Intenta una grabación más corta."); }
            document.getElementById('processingOverlay').style.display = 'none';
        }

        btnStart.onclick = startRecording;
        btnPause.onclick = () => isPaused ? resumeRecording() : pauseRecording();
        btnStop.onclick = stopRecording;
        btnClear.onclick = clearData;
        document.getElementById('btnExportAudio').onclick = exportMp3;
        document.getElementById('btnExportTxt').onclick = () => {
            const text = Array.from(document.querySelectorAll('.speaker-block')).map(p => p.innerText).join('\n\n');
            const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `STENOTIPISTA_TEXTO_${Date.now()}.txt`;
            a.click();
        };
    </script>
</body>
</html>